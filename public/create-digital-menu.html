<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Digital Menu - MagicPlate.ai</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- CSV parser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Excel parser (SheetJS) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- QR Code -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #4caf50;
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 20px;
      transition: color 0.2s;
    }
    .back-link:hover { color: #66bb6a; }
    h1 {
      font-size: 2.4em;
      font-weight: 800;
      background: linear-gradient(135deg, #4caf50, #81c784);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #999;
      font-size: 1.1em;
      margin-bottom: 30px;
    }

    /* Steps indicator */
    .steps {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
    }
    .step {
      flex: 1;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      border: 2px solid rgba(255,255,255,0.08);
      text-align: center;
      font-weight: 600;
      font-size: 0.85em;
      color: #666;
      transition: all 0.3s;
    }
    .step.active {
      border-color: #4caf50;
      color: #4caf50;
      background: rgba(76,175,80,0.08);
    }
    .step.done {
      border-color: rgba(76,175,80,0.3);
      color: #81c784;
      background: rgba(76,175,80,0.05);
    }
    .step-num {
      display: block;
      font-size: 1.2em;
      margin-bottom: 2px;
    }

    /* Card sections */
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
    }
    .card h2 {
      font-size: 1.3em;
      margin-bottom: 6px;
      color: #fff;
    }
    .card .desc {
      color: #888;
      font-size: 0.9em;
      margin-bottom: 20px;
    }

    /* Upload zone */
    .upload-zone {
      border: 2px dashed rgba(76,175,80,0.3);
      border-radius: 14px;
      padding: 50px 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(76,175,80,0.03);
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: #4caf50;
      background: rgba(76,175,80,0.08);
    }
    .upload-zone .icon { font-size: 2.5em; margin-bottom: 12px; }
    .upload-zone .label { font-weight: 600; color: #ccc; margin-bottom: 6px; }
    .upload-zone .hint { color: #777; font-size: 0.85em; }
    .upload-zone input[type="file"] { display: none; }

    /* Format badges */
    .format-badges {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .format-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75em;
      font-weight: 600;
      border: 1px solid rgba(255,255,255,0.1);
      color: #999;
    }
    .format-badge.csv { border-color: rgba(76,175,80,0.3); color: #81c784; }
    .format-badge.excel { border-color: rgba(33,150,83,0.3); color: #66bb6a; }
    .format-badge.text { border-color: rgba(255,193,7,0.3); color: #ffd54f; }
    .format-badge.json { border-color: rgba(33,150,243,0.3); color: #64b5f6; }
    .format-badge.paste { border-color: rgba(171,71,188,0.3); color: #ce93d8; }

    /* Divider */
    .or-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      color: #555;
      font-size: 0.85em;
      font-weight: 600;
    }
    .or-divider::before, .or-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: rgba(255,255,255,0.08);
    }

    /* Paste area */
    .paste-area {
      position: relative;
    }
    .paste-area textarea {
      width: 100%;
      min-height: 160px;
      padding: 16px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      color: #ccc;
      font-family: 'Inter', monospace;
      font-size: 0.9em;
      line-height: 1.6;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s;
    }
    .paste-area textarea:focus { border-color: #4caf50; }
    .paste-area textarea::placeholder { color: #555; }
    .paste-area .paste-hint {
      font-size: 0.78em;
      color: #666;
      margin-top: 8px;
      line-height: 1.5;
    }
    .paste-btn {
      margin-top: 12px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #7c4dff, #651fff);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .paste-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,77,255,0.3); }
    .paste-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Sample */
    .sample-section {
      margin-top: 16px;
      text-align: center;
    }
    .sample-btn {
      background: none;
      border: 1px solid rgba(76,175,80,0.3);
      color: #4caf50;
      padding: 8px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85em;
      font-family: inherit;
      transition: all 0.2s;
    }
    .sample-btn:hover {
      background: rgba(76,175,80,0.1);
      border-color: #4caf50;
    }

    /* â”€â”€ Trial Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trial-banner {
      background: linear-gradient(135deg, rgba(255,243,224,0.12), rgba(255,248,225,0.08));
      border: 1px solid rgba(255,224,178,0.2);
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 20px;
    }
    .trial-banner-text {
      font-size: 0.92em;
      color: #ffb74d;
      font-weight: 600;
    }
    .trial-banner-text span {
      font-weight: 800;
      color: #ff9800;
    }

    /* â”€â”€ Signup Gate Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gate-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px);
      z-index: 99999;
      align-items: center;
      justify-content: center;
    }
    .gate-overlay.active { display: flex; }
    .gate-card {
      background: white;
      border-radius: 20px;
      padding: 48px;
      max-width: 480px;
      width: 92%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      position: relative;
      animation: gateSlideIn 0.35s ease-out;
      color: #1a1a1a;
    }
    @keyframes gateSlideIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .gate-card h2 { font-size: 1.7em; font-weight: 800; margin-bottom: 10px; }
    .gate-card > p { color: #666; margin-bottom: 24px; font-size: 1.05em; line-height: 1.5; }
    .gate-close {
      position: absolute; top: 14px; right: 18px;
      background: none; border: none; font-size: 26px; cursor: pointer; color: #999;
    }
    .gate-close:hover { color: #333; }
    .gate-form { text-align: left; }
    .gate-form label { display: block; font-weight: 600; margin-bottom: 4px; font-size: 14px; color: #333; }
    .gate-form input {
      width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px;
      font-size: 15px; margin-bottom: 14px; transition: border-color 0.3s; font-family: inherit;
      color: #333; background: white;
    }
    .gate-form input:focus { border-color: #4caf50; outline: none; }
    .gate-submit {
      width: 100%; padding: 14px;
      background: linear-gradient(135deg,#4caf50,#66bb6a);
      color: white; border: none; border-radius: 12px; font-size: 16px;
      font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 6px; font-family: inherit;
    }
    .gate-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76,175,80,0.35); }
    .gate-success { display: none; text-align: center; padding: 20px; }
    .gate-success h3 { color: #4caf50; font-size: 1.4em; margin-bottom: 8px; }

    /* Detected source badge */
    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.8em;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .source-badge.csv { background: rgba(76,175,80,0.1); color: #81c784; }
    .source-badge.excel { background: rgba(33,150,83,0.1); color: #66bb6a; }
    .source-badge.tsv { background: rgba(0,188,212,0.1); color: #4dd0e1; }
    .source-badge.json { background: rgba(33,150,243,0.1); color: #64b5f6; }
    .source-badge.text { background: rgba(255,193,7,0.1); color: #ffd54f; }
    .source-badge.paste { background: rgba(171,71,188,0.1); color: #ce93d8; }

    /* Style selector */
    .style-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .style-option {
      padding: 10px 20px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9em;
      font-family: inherit;
      color: #aaa;
      background: transparent;
      transition: all 0.2s;
    }
    .style-option:hover { border-color: rgba(76,175,80,0.4); color: #ccc; }
    .style-option.selected {
      border-color: #4caf50;
      color: #4caf50;
      background: rgba(76,175,80,0.08);
    }

    /* Restaurant name */
    .input-group {
      margin-bottom: 16px;
    }
    .input-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #ccc;
      font-size: 0.9em;
    }
    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-size: 1em;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-group input:focus { border-color: #4caf50; }
    .input-group input::placeholder { color: #555; }

    /* Preview table */
    .table-wrap {
      overflow-x: auto;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    th {
      background: rgba(76,175,80,0.1);
      color: #4caf50;
      text-align: left;
      padding: 12px 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    td {
      padding: 10px 14px;
      border-top: 1px solid rgba(255,255,255,0.05);
      color: #ccc;
    }
    tr:hover td { background: rgba(255,255,255,0.02); }
    .remove-row {
      background: none;
      border: none;
      color: #e57373;
      cursor: pointer;
      font-size: 1.1em;
      padding: 4px;
    }

    /* Buttons */
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1em;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #4caf50, #388e3c);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76,175,80,0.3);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.08);
      color: #ccc;
    }
    .btn-secondary:hover:not(:disabled) {
      background: rgba(255,255,255,0.12);
    }
    .btn-row {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    /* Progress */
    .progress-section {
      display: none;
    }
    .progress-bar-track {
      height: 8px;
      background: rgba(255,255,255,0.08);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #81c784);
      border-radius: 4px;
      width: 0%;
      transition: width 0.4s ease;
    }
    .progress-status {
      color: #999;
      font-size: 0.9em;
      margin-bottom: 16px;
    }
    .dish-progress-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    .dish-progress-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      font-size: 0.88em;
    }
    .dish-progress-item .status-icon {
      width: 20px;
      text-align: center;
    }
    .dish-progress-item.pending .status-icon { color: #666; }
    .dish-progress-item.generating .status-icon { color: #ffa726; }
    .dish-progress-item.done .status-icon { color: #4caf50; }
    .dish-progress-item.error .status-icon { color: #e57373; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { display: inline-block; animation: spin 1s linear infinite; }

    /* Result section */
    .result-section {
      display: none;
      text-align: center;
    }
    .result-section .success-icon {
      font-size: 3em;
      margin-bottom: 12px;
    }
    .result-section h2 {
      color: #4caf50;
      margin-bottom: 8px;
    }
    .result-link {
      display: inline-block;
      background: rgba(76,175,80,0.1);
      border: 1px solid rgba(76,175,80,0.3);
      border-radius: 10px;
      padding: 14px 24px;
      color: #4caf50;
      text-decoration: none;
      font-weight: 600;
      margin: 16px 0;
      transition: all 0.2s;
      word-break: break-all;
    }
    .result-link:hover {
      background: rgba(76,175,80,0.15);
      border-color: #4caf50;
    }

    /* QR Section */
    .qr-section {
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .qr-section h3 {
      color: #ccc;
      font-size: 1.1em;
      margin-bottom: 4px;
    }
    .qr-section .qr-desc {
      color: #777;
      font-size: 0.85em;
      margin-bottom: 16px;
    }
    .qr-wrapper {
      display: inline-block;
      background: white;
      padding: 20px;
      border-radius: 14px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.3);
    }
    .qr-wrapper #resultQrCode canvas,
    .qr-wrapper #resultQrCode img {
      display: block;
    }
    .qr-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .qr-actions button {
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.06);
      color: #ccc;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .qr-actions button:hover { background: rgba(255,255,255,0.12); border-color: #4caf50; color: #fff; }
    .copy-toast {
      display: none;
      padding: 8px 16px;
      background: #4caf50;
      color: white;
      border-radius: 8px;
      font-size: 0.82em;
      font-weight: 600;
      margin-top: 10px;
    }

    /* Alert */
    .alert {
      padding: 14px 18px;
      border-radius: 10px;
      margin-bottom: 16px;
      display: none;
      font-size: 0.9em;
    }
    .alert-error {
      background: rgba(229,115,115,0.1);
      border: 1px solid rgba(229,115,115,0.3);
      color: #e57373;
    }
    .alert-info {
      background: rgba(76,175,80,0.08);
      border: 1px solid rgba(76,175,80,0.3);
      color: #81c784;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 12px; }
      .card { padding: 20px; }
      h1 { font-size: 1.8em; }
      .steps { flex-direction: column; }
      .style-row { flex-direction: column; }
      .style-option { text-align: center; }
      .format-badges { gap: 6px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/features.html" class="back-link">â† Back to Features</a>

    <!-- Trial Banner -->
    <div class="trial-banner" id="trialBanner">
      <span class="trial-banner-text" id="trialBannerText">ğŸ‰ <span>1 Free Practice Menu</span> â€” Try our digital menu creator, no sign-up needed!</span>
    </div>

    <h1>Create Digital Menu</h1>
    <p class="subtitle">Upload your menu from any source â€” CSV, Excel, Notes, text, or just paste it â€” and we'll generate AI food photos for every dish.</p>

    <!-- Steps indicator -->
    <div class="steps">
      <div class="step active" id="step1"><span class="step-num">1</span> Upload Menu</div>
      <div class="step" id="step2"><span class="step-num">2</span> Preview &amp; Configure</div>
      <div class="step" id="step3"><span class="step-num">3</span> Generate Images</div>
      <div class="step" id="step4"><span class="step-num">4</span> Your Menu</div>
    </div>

    <div id="alertBox" class="alert"></div>

    <!-- STEP 1: Upload -->
    <div class="card" id="uploadCard">
      <h2>ğŸ“ Upload or Paste Your Menu</h2>
      <p class="desc">We'll auto-detect dish names, prices, and ingredients from any format. Column names and layouts are auto-detected.</p>

      <div class="upload-zone" id="uploadZone">
        <div class="icon">ğŸ“„</div>
        <div class="label">Drag &amp; drop your menu file here</div>
        <div class="hint">or click to browse</div>
        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.tsv,.txt,.json,.numbers">
      </div>

      <div class="format-badges">
        <span class="format-badge csv">ğŸ“Š CSV</span>
        <span class="format-badge excel">ğŸ“— Excel (.xlsx)</span>
        <span class="format-badge text">ğŸ“ Text / Notes</span>
        <span class="format-badge tsv" style="border-color:rgba(0,188,212,0.3); color:#4dd0e1;">ğŸ“‹ TSV</span>
        <span class="format-badge json">ğŸ“¦ JSON</span>
        <span class="format-badge paste">ğŸ“± Paste</span>
      </div>

      <div class="or-divider">or paste your menu below</div>

      <div class="paste-area">
        <textarea id="pasteInput" placeholder="Paste your menu here â€” from Notes, Google Sheets, a PDF copy, or just type it out...

Examples of formats we understand:

Margherita Pizza - Tomato, mozzarella, basil - $12.99
Grilled Salmon    $24.99    Atlantic salmon, lemon butter
Caesar Salad      11.49     Romaine, parmesan, croutons

Or even a simple list:
Burger $15
Pasta $18
Salad $11"></textarea>
        <p class="paste-hint">ğŸ’¡ <strong>Tip:</strong> We understand most formats â€” tables, lists, tabs, commas, dashes. Just paste whatever you have and we'll figure it out. Prices are optional.</p>
        <button class="paste-btn" id="parsePasteBtn" type="button">âœ¨ Parse Menu</button>
      </div>

      <div class="sample-section">
        <button class="sample-btn" id="loadSampleBtn">Load sample menu to try it out</button>
        <span style="color:#666; font-size:0.8em; margin-left:10px;">or</span>
        <button class="sample-btn" id="downloadSampleBtn">Download sample CSV</button>
      </div>
    </div>

    <!-- STEP 2: Preview -->
    <div class="card" id="previewCard" style="display:none;">
      <h2>Preview Your Menu</h2>
      <p class="desc">Review the parsed items below. Remove any rows you don't want, or edit inline.</p>

      <div id="sourceBadge" style="margin-bottom:16px;"></div>

      <div class="input-group">
        <label>Restaurant Name</label>
        <input type="text" id="restaurantName" placeholder="e.g., The Golden Fork" />
      </div>

      <div class="input-group">
        <label>Image Style</label>
        <div class="style-row" id="styleRow">
          <button type="button" class="style-option selected" data-style="professional">Professional</button>
          <button type="button" class="style-option" data-style="rustic">Rustic</button>
          <button type="button" class="style-option" data-style="modern">Modern / Fine Dining</button>
          <button type="button" class="style-option" data-style="casual">Casual / Bright</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="previewTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Dish Name</th>
              <th>Ingredients / Description</th>
              <th>Price</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary" id="backToUpload">â† Back</button>
        <button class="btn btn-primary" id="generateBtn">ğŸš€ Generate Menu Images</button>
      </div>
    </div>

    <!-- STEP 3: Generating -->
    <div class="card progress-section" id="progressCard">
      <h2>Generating AI Images...</h2>
      <p class="desc">This may take a minute. Each dish gets its own AI-generated food photo.</p>
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <div class="progress-status" id="progressStatus">Starting...</div>
      <div class="dish-progress-list" id="dishProgressList"></div>
    </div>

    <!-- STEP 4: Result -->
    <div class="card result-section" id="resultCard">
      <div class="success-icon">ğŸ‰</div>
      <h2>Your Digital Menu is Ready!</h2>
      <p class="desc" id="resultDesc">Your menu has been generated with AI food photos.</p>
      <a href="#" class="result-link" id="viewMenuLink" target="_blank">View Your Menu â†’</a>
      <div class="btn-row" style="justify-content:center;">
        <button class="btn btn-secondary" id="downloadMenuBtn">â¬‡ Download as HTML</button>
        <button class="btn btn-secondary" id="createAnotherBtn">+ Create Another Menu</button>
      </div>

      <!-- QR Code Section -->
      <div class="qr-section">
        <h3>ğŸ“± Share via QR Code</h3>
        <p class="qr-desc">Print this QR code on table tents, receipts, or flyers â€” customers scan to see your menu instantly.</p>
        <div class="qr-wrapper">
          <div id="resultQrCode"></div>
        </div>
        <div class="qr-actions">
          <button id="downloadQrBtn" type="button">â¬‡ Download QR Code</button>
          <button id="copyLinkBtn" type="button">ğŸ“‹ Copy Menu Link</button>
          <button id="shareBtn" type="button">ğŸ“¤ Share</button>
        </div>
        <div class="copy-toast" id="copyToast">âœ… Link copied to clipboard!</div>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let parsedDishes = [];
    let generatedMenu = null;
    let selectedStyle = 'professional';
    let detectedSource = '';
    let menuViewerUrl = '';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SAMPLE DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SAMPLE_CSV = `dish_name,ingredients,price
Margherita Pizza,"Tomato sauce, mozzarella, fresh basil, olive oil",$12.99
Grilled Salmon,"Atlantic salmon, lemon butter sauce, asparagus, roasted potatoes",$24.99
Classic Cheeseburger,"Angus beef patty, cheddar cheese, lettuce, tomato, pickles, brioche bun",$15.99
Caesar Salad,"Romaine lettuce, parmesan, croutons, creamy Caesar dressing",$11.49
Chicken Tikka Masala,"Tandoori chicken, creamy tomato curry sauce, basmati rice, naan bread",$18.99
Pasta Carbonara,"Spaghetti, pancetta, egg yolk, pecorino Romano, black pepper",$16.99
Chocolate Lava Cake,"Dark chocolate, molten center, vanilla ice cream, raspberry coulis",$9.99`;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  COLUMN DETECTION (for structured data)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function detectColumns(headers) {
      const lower = headers.map(h => h.toLowerCase().trim());
      const nameCol = lower.findIndex(h =>
        ['dish_name','dishname','dish','name','item','item_name','itemname','menu_item','food','food_name','product','title','menu item','dish name','item name','food name','entree','entrÃ©e','meal'].includes(h)
      );
      const ingredCol = lower.findIndex(h =>
        ['ingredients','ingredient','description','desc','details','contents','notes','info','about','composition'].includes(h)
      );
      const priceCol = lower.findIndex(h =>
        ['price','cost','amount','menu_price','rate','value','$','usd'].includes(h)
      );
      return { nameCol, ingredCol, priceCol };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STRUCTURED PARSERS (CSV, Excel, TSV, JSON)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function parseStructuredRows(headers, rows) {
      const { nameCol, ingredCol, priceCol } = detectColumns(headers);

      // If no name column detected, try first non-price column
      let actualNameCol = nameCol;
      if (actualNameCol === -1) {
        // Use first column that doesn't look like a price
        for (let i = 0; i < headers.length; i++) {
          if (i !== priceCol) { actualNameCol = i; break; }
        }
      }
      if (actualNameCol === -1) actualNameCol = 0;

      const nameKey = headers[actualNameCol];
      const ingredKey = ingredCol !== -1 ? headers[ingredCol] : null;
      const priceKey = priceCol !== -1 ? headers[priceCol] : null;

      // If no explicit ingredient column, try to find one that's not name or price
      let fallbackIngredKey = null;
      if (!ingredKey) {
        for (let i = 0; i < headers.length; i++) {
          if (i !== actualNameCol && i !== priceCol) {
            fallbackIngredKey = headers[i];
            break;
          }
        }
      }

      const dishes = [];
      for (const row of rows) {
        const name = (row[nameKey] || '').toString().trim();
        if (!name) continue;
        // Skip header-like rows
        if (name.toLowerCase() === 'name' || name.toLowerCase() === 'dish' || name.toLowerCase() === 'item') continue;

        dishes.push({
          dish_name: name,
          ingredients: ingredKey ? (row[ingredKey] || '').toString().trim() : (fallbackIngredKey ? (row[fallbackIngredKey] || '').toString().trim() : ''),
          price: priceKey ? normalizePrice((row[priceKey] || '').toString().trim()) : ''
        });
      }
      return dishes;
    }

    function parseCSVData(results) {
      if (!results.data || results.data.length === 0) {
        showAlert('File appears to be empty.', 'error');
        return [];
      }
      const headers = results.meta.fields || Object.keys(results.data[0] || {});
      return parseStructuredRows(headers, results.data);
    }

    function parseExcelFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

            if (!jsonData || jsonData.length === 0) {
              reject(new Error('Spreadsheet appears to be empty.'));
              return;
            }

            const headers = Object.keys(jsonData[0]);
            const dishes = parseStructuredRows(headers, jsonData);
            resolve(dishes);
          } catch (err) {
            reject(err);
          }
        };
        reader.onerror = () => reject(new Error('Failed to read file.'));
        reader.readAsArrayBuffer(file);
      });
    }

    function parseJSONData(text) {
      try {
        let data = JSON.parse(text);

        // Handle common JSON shapes:
        // 1. Array of objects [{name, price, ...}]
        // 2. Object with items key { items: [...], menu: [...] }
        if (!Array.isArray(data)) {
          const keys = Object.keys(data);
          const arrayKey = keys.find(k => Array.isArray(data[k]));
          if (arrayKey) {
            data = data[arrayKey];
          } else {
            showAlert('JSON must contain an array of menu items.', 'error');
            return [];
          }
        }

        if (data.length === 0) {
          showAlert('JSON array is empty.', 'error');
          return [];
        }

        const headers = Object.keys(data[0]);
        return parseStructuredRows(headers, data);
      } catch (e) {
        showAlert('Invalid JSON: ' + e.message, 'error');
        return [];
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SMART TEXT PARSER (Notes, plain text, etc.)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function normalizePrice(s) {
      if (!s) return '';
      s = s.toString().trim();
      // Already has $
      if (/^\$/.test(s)) return s;
      // Just a number like "12.99" or "15"
      if (/^\d+(\.\d{1,2})?$/.test(s)) return '$' + s;
      return s;
    }

    function parseSmartText(text) {
      const lines = text.split(/\n/).map(l => l.trim()).filter(l => l.length > 0);
      const dishes = [];
      const priceRegex = /\$?\d{1,4}(?:\.\d{1,2})?/;
      const skipWords = new Set([
        'menu', 'appetizers', 'appetizer', 'entrees', 'entrÃ©es', 'entree', 'entrÃ©e',
        'mains', 'main course', 'sides', 'side dishes', 'desserts', 'dessert',
        'beverages', 'drinks', 'salads', 'soups', 'specials', 'starters',
        'breakfast', 'lunch', 'dinner', 'brunch', 'happy hour', 'kids menu',
        'sandwiches', 'burgers', 'pizzas', 'pasta', 'seafood', 'from the grill',
        'chef\'s specials', 'wine list', 'beer', 'cocktails'
      ]);

      for (let line of lines) {
        // Skip section headers (all caps, short, or matching known headers)
        const lower = line.toLowerCase().replace(/[^a-z\s]/g, '').trim();
        if (skipWords.has(lower)) continue;
        if (/^[A-Z\s\-â€”]{2,30}$/.test(line) && !priceRegex.test(line)) continue;
        if (/^[-=_*#]{2,}$/.test(line)) continue; // decorative lines

        // Try to extract price
        let price = '';
        const priceMatch = line.match(/\$\s?\d{1,4}(?:\.\d{1,2})?|\b\d{1,4}\.\d{2}\b/);
        if (priceMatch) {
          price = normalizePrice(priceMatch[0].trim());
          line = line.replace(priceMatch[0], '').trim();
        }

        // Clean up separators at the end after price removal
        line = line.replace(/[\s\-â€”|:;,.\t]+$/, '').trim();
        if (!line) continue;

        // Try to split name from description
        // Patterns: "Name - description", "Name: description", "Name | description",
        //           "Name\tdescription", "Name  description" (double space)
        let dishName = '';
        let ingredients = '';

        // Tab-separated
        if (line.includes('\t')) {
          const parts = line.split('\t').map(s => s.trim()).filter(s => s);
          dishName = parts[0] || '';
          ingredients = parts.slice(1).join(', ');
        }
        // Dash/em-dash separator (but not inside words)
        else if (/\s[-â€“â€”]\s/.test(line)) {
          const idx = line.search(/\s[-â€“â€”]\s/);
          dishName = line.substring(0, idx).trim();
          ingredients = line.substring(idx + 3).trim();
        }
        // Pipe separator
        else if (line.includes('|')) {
          const parts = line.split('|').map(s => s.trim()).filter(s => s);
          dishName = parts[0] || '';
          ingredients = parts.slice(1).join(', ');
        }
        // Colon separator (but not if it's a time like 10:00)
        else if (/:\s/.test(line) && !/\d:\d/.test(line)) {
          const idx = line.indexOf(':');
          dishName = line.substring(0, idx).trim();
          ingredients = line.substring(idx + 1).trim();
        }
        // Double-space separator
        else if (/\s{2,}/.test(line)) {
          const parts = line.split(/\s{2,}/).map(s => s.trim()).filter(s => s);
          dishName = parts[0] || '';
          // Rest could be ingredients or additional price-like stuff
          const restParts = parts.slice(1);
          const ingredParts = restParts.filter(p => !/^\$?\d+(\.\d{2})?$/.test(p));
          const priceParts = restParts.filter(p => /^\$?\d+(\.\d{2})?$/.test(p));
          ingredients = ingredParts.join(', ');
          if (!price && priceParts.length > 0) {
            price = normalizePrice(priceParts[0]);
          }
        }
        // Comma-separated with first part as name
        else if (line.includes(',') && line.split(',').length >= 2) {
          const parts = line.split(',').map(s => s.trim());
          dishName = parts[0];
          ingredients = parts.slice(1).join(', ');
        }
        // Just a name
        else {
          dishName = line;
        }

        // Clean up dish name
        dishName = dishName.replace(/^[\d.)\]\s]+/, '').trim(); // Remove leading numbers "1. Burger" -> "Burger"
        dishName = dishName.replace(/^\*+|\*+$/g, '').trim(); // Remove markdown bold

        if (!dishName || dishName.length < 2) continue;
        // Skip if it looks like a price only
        if (/^\$?\d+(\.\d{2})?$/.test(dishName)) continue;

        dishes.push({
          dish_name: dishName,
          ingredients: ingredients,
          price: price
        });
      }

      return dishes;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UI HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showAlert(msg, type = 'error') {
      const box = document.getElementById('alertBox');
      box.textContent = msg;
      box.className = `alert alert-${type}`;
      box.style.display = 'block';
      setTimeout(() => { box.style.display = 'none'; }, 8000);
    }

    function setStep(n) {
      for (let i = 1; i <= 4; i++) {
        const el = document.getElementById(`step${i}`);
        el.classList.remove('active', 'done');
        if (i < n) el.classList.add('done');
        if (i === n) el.classList.add('active');
      }
    }

    function renderPreviewTable() {
      const tbody = document.getElementById('previewBody');
      tbody.innerHTML = '';
      parsedDishes.forEach((d, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td contenteditable="true" class="editable" data-idx="${i}" data-field="dish_name">${esc(d.dish_name)}</td>
          <td contenteditable="true" class="editable" data-idx="${i}" data-field="ingredients">${esc(d.ingredients)}</td>
          <td contenteditable="true" class="editable" data-idx="${i}" data-field="price">${esc(d.price)}</td>
          <td><button class="remove-row" data-idx="${i}" title="Remove">âœ•</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Remove handlers
      tbody.querySelectorAll('.remove-row').forEach(btn => {
        btn.addEventListener('click', () => {
          parsedDishes.splice(parseInt(btn.dataset.idx), 1);
          renderPreviewTable();
        });
      });

      // Inline edit handlers
      tbody.querySelectorAll('.editable').forEach(cell => {
        cell.addEventListener('blur', () => {
          const idx = parseInt(cell.dataset.idx);
          const field = cell.dataset.field;
          parsedDishes[idx][field] = cell.textContent.trim();
        });
      });
    }

    function showSourceBadge(source) {
      const labels = {
        csv: { icon: 'ğŸ“Š', label: 'CSV', cls: 'csv' },
        excel: { icon: 'ğŸ“—', label: 'Excel Spreadsheet', cls: 'excel' },
        tsv: { icon: 'ğŸ“‹', label: 'Tab-Separated', cls: 'tsv' },
        json: { icon: 'ğŸ“¦', label: 'JSON', cls: 'json' },
        text: { icon: 'ğŸ“', label: 'Text / Notes', cls: 'text' },
        paste: { icon: 'ğŸ“±', label: 'Pasted Text', cls: 'paste' }
      };
      const s = labels[source] || labels.text;
      document.getElementById('sourceBadge').innerHTML =
        `<span class="source-badge ${s.cls}">${s.icon} Detected: ${s.label} â€” ${parsedDishes.length} items found</span>`;
    }

    function esc(s) {
      const d = document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FILE HANDLING â€” UNIVERSAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('click', () => fileInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
    uploadZone.addEventListener('drop', e => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files[0]) handleFile(fileInput.files[0]);
    });

    async function handleFile(file) {
      const name = file.name.toLowerCase();
      const ext = name.split('.').pop();

      try {
        // â”€â”€ Excel â”€â”€
        if (['xlsx', 'xls', 'numbers'].includes(ext) || file.type.includes('spreadsheet') || file.type.includes('excel')) {
          detectedSource = 'excel';
          parsedDishes = await parseExcelFile(file);
          if (parsedDishes.length > 0) {
            showAlert(`âœ… Parsed ${parsedDishes.length} items from Excel spreadsheet.`, 'info');
            goToPreview();
          } else {
            showAlert('Could not find menu items in this spreadsheet. Make sure it has dish names.', 'error');
          }
          return;
        }

        // â”€â”€ JSON â”€â”€
        if (ext === 'json' || file.type === 'application/json') {
          const text = await file.text();
          detectedSource = 'json';
          parsedDishes = parseJSONData(text);
          if (parsedDishes.length > 0) {
            showAlert(`âœ… Parsed ${parsedDishes.length} items from JSON.`, 'info');
            goToPreview();
          }
          return;
        }

        // â”€â”€ TSV â”€â”€
        if (ext === 'tsv') {
          const text = await file.text();
          detectedSource = 'tsv';
          Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            delimiter: '\t',
            complete: (results) => {
              parsedDishes = parseCSVData(results);
              if (parsedDishes.length > 0) {
                showAlert(`âœ… Parsed ${parsedDishes.length} items from TSV.`, 'info');
                goToPreview();
              } else {
                showAlert('Could not find menu items in this file.', 'error');
              }
            },
            error: (err) => showAlert('Parse error: ' + err.message, 'error')
          });
          return;
        }

        // â”€â”€ CSV â”€â”€
        if (ext === 'csv' || file.type === 'text/csv') {
          detectedSource = 'csv';
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
              parsedDishes = parseCSVData(results);
              if (parsedDishes.length > 0) {
                showAlert(`âœ… Parsed ${parsedDishes.length} items from CSV.`, 'info');
                goToPreview();
              } else {
                showAlert('Could not find menu items. Check column names.', 'error');
              }
            },
            error: (err) => showAlert('CSV parse error: ' + err.message, 'error')
          });
          return;
        }

        // â”€â”€ Plain text (.txt, or anything else) â”€â”€
        const text = await file.text();
        detectedSource = 'text';

        // First try PapaParse auto-detect (handles CSVs saved as .txt)
        const papaResult = Papa.parse(text, { header: true, skipEmptyLines: true });
        if (papaResult.meta.fields && papaResult.meta.fields.length >= 2 && papaResult.data.length > 0) {
          const { nameCol } = detectColumns(papaResult.meta.fields);
          if (nameCol !== -1) {
            detectedSource = 'csv';
            parsedDishes = parseCSVData(papaResult);
            if (parsedDishes.length > 0) {
              showAlert(`âœ… Detected structured data â€” parsed ${parsedDishes.length} items.`, 'info');
              goToPreview();
              return;
            }
          }
        }

        // Fall back to smart text parser
        parsedDishes = parseSmartText(text);
        if (parsedDishes.length > 0) {
          showAlert(`âœ… Parsed ${parsedDishes.length} items from text file.`, 'info');
          goToPreview();
        } else {
          showAlert('Could not find menu items in this file. Try pasting the content below instead.', 'error');
        }

      } catch (err) {
        console.error('File parse error:', err);
        showAlert('Failed to parse file: ' + err.message, 'error');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PASTE HANDLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('parsePasteBtn').addEventListener('click', () => {
      const text = document.getElementById('pasteInput').value.trim();
      if (!text) {
        showAlert('Please paste your menu content first.', 'error');
        return;
      }

      detectedSource = 'paste';

      // Try structured parse first (CSV pasted as text)
      const papaResult = Papa.parse(text, { header: true, skipEmptyLines: true });
      if (papaResult.meta.fields && papaResult.meta.fields.length >= 2 && papaResult.data.length > 0) {
        const { nameCol } = detectColumns(papaResult.meta.fields);
        if (nameCol !== -1) {
          detectedSource = 'csv';
          parsedDishes = parseCSVData(papaResult);
          if (parsedDishes.length > 0) {
            showAlert(`âœ… Detected structured data â€” parsed ${parsedDishes.length} items.`, 'info');
            goToPreview();
            return;
          }
        }
      }

      // Try JSON
      if (text.startsWith('[') || text.startsWith('{')) {
        try {
          detectedSource = 'json';
          parsedDishes = parseJSONData(text);
          if (parsedDishes.length > 0) {
            showAlert(`âœ… Parsed ${parsedDishes.length} items from JSON.`, 'info');
            goToPreview();
            return;
          }
        } catch (e) { /* Not JSON, continue */ }
      }

      // Smart text parser
      parsedDishes = parseSmartText(text);
      if (parsedDishes.length > 0) {
        showAlert(`âœ… Parsed ${parsedDishes.length} items from pasted text.`, 'info');
        goToPreview();
      } else {
        showAlert('Could not find menu items. Try formatting as: "Dish Name - Ingredients - $Price" (one per line).', 'error');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SAMPLE BUTTONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('loadSampleBtn').addEventListener('click', () => {
      detectedSource = 'csv';
      const results = Papa.parse(SAMPLE_CSV, { header: true, skipEmptyLines: true });
      parsedDishes = parseCSVData(results);
      if (parsedDishes.length > 0) goToPreview();
    });

    document.getElementById('downloadSampleBtn').addEventListener('click', () => {
      const blob = new Blob([SAMPLE_CSV], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sample-menu.csv';
      a.click();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function goToPreview() {
      document.getElementById('uploadCard').style.display = 'none';
      document.getElementById('previewCard').style.display = 'block';
      document.getElementById('progressCard').style.display = 'none';
      document.getElementById('resultCard').style.display = 'none';
      setStep(2);
      showSourceBadge(detectedSource);
      renderPreviewTable();
    }

    document.getElementById('backToUpload').addEventListener('click', () => {
      document.getElementById('uploadCard').style.display = 'block';
      document.getElementById('previewCard').style.display = 'none';
      setStep(1);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STYLE SELECTOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.querySelectorAll('.style-option').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.style-option').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedStyle = btn.dataset.style;
      });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GENERATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('generateBtn').addEventListener('click', startGeneration);

    async function startGeneration() {
      if (parsedDishes.length === 0) {
        showAlert('No dishes to generate.', 'error');
        return;
      }

      // â”€â”€ Free trial check â”€â”€
      if (!hasMenuTrialRemaining()) {
        openGate();
        return;
      }

      const restaurantName = document.getElementById('restaurantName').value.trim() || 'My Restaurant';

      document.getElementById('previewCard').style.display = 'none';
      const progressCard = document.getElementById('progressCard');
      progressCard.style.display = 'block';
      setStep(3);

      const list = document.getElementById('dishProgressList');
      list.innerHTML = '';
      parsedDishes.forEach((d, i) => {
        const div = document.createElement('div');
        div.className = 'dish-progress-item pending';
        div.id = `dish-prog-${i}`;
        div.innerHTML = `<span class="status-icon">â³</span><span>${esc(d.dish_name)}</span>`;
        list.appendChild(div);
      });

      const completed = [];
      let errors = 0;

      for (let i = 0; i < parsedDishes.length; i++) {
        const dish = parsedDishes[i];
        const itemEl = document.getElementById(`dish-prog-${i}`);

        itemEl.className = 'dish-progress-item generating';
        itemEl.querySelector('.status-icon').innerHTML = '<span class="spinner">â³</span>';
        document.getElementById('progressStatus').textContent = `Generating image ${i + 1} of ${parsedDishes.length}: ${dish.dish_name}`;
        document.getElementById('progressFill').style.width = `${((i) / parsedDishes.length) * 100}%`;

        try {
          const res = await fetch('/api/generate-dish-image', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              dish_name: dish.dish_name,
              ingredients: dish.ingredients,
              style: selectedStyle
            })
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.message || data.error || 'Generation failed');

          completed.push({ ...dish, imageUrl: data.imageUrl });
          itemEl.className = 'dish-progress-item done';
          itemEl.querySelector('.status-icon').textContent = 'âœ…';
        } catch (err) {
          console.error(`Failed to generate image for ${dish.dish_name}:`, err);
          completed.push({ ...dish, imageUrl: null, error: err.message });
          itemEl.className = 'dish-progress-item error';
          itemEl.querySelector('.status-icon').textContent = 'âŒ';
          errors++;
        }

        document.getElementById('progressFill').style.width = `${((i + 1) / parsedDishes.length) * 100}%`;
      }

      document.getElementById('progressStatus').textContent = `Done! ${completed.length - errors} of ${completed.length} images generated.`;

      // Save to localStorage
      const menuId = 'menu_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
      generatedMenu = {
        id: menuId,
        restaurant: restaurantName,
        style: selectedStyle,
        source: detectedSource,
        items: completed,
        createdAt: new Date().toISOString()
      };
      localStorage.setItem(menuId, JSON.stringify(generatedMenu));

      const menuList = JSON.parse(localStorage.getItem('magicplate_menus') || '[]');
      menuList.push({ id: menuId, restaurant: restaurantName, createdAt: generatedMenu.createdAt, itemCount: completed.length });
      localStorage.setItem('magicplate_menus', JSON.stringify(menuList));

      // Track usage for free trial
      incrementMenuCreateCount();

      setTimeout(() => showResult(menuId, errors), 1200);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RESULT + QR CODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showResult(menuId, errors) {
      document.getElementById('progressCard').style.display = 'none';
      const resultCard = document.getElementById('resultCard');
      resultCard.style.display = 'block';
      setStep(4);

      const viewerUrl = `/menu-viewer.html?id=${menuId}`;
      menuViewerUrl = `${window.location.origin}${viewerUrl}`;

      document.getElementById('viewMenuLink').href = viewerUrl;
      document.getElementById('viewMenuLink').textContent = menuViewerUrl;

      if (errors > 0) {
        document.getElementById('resultDesc').textContent = `Generated with ${errors} failed image(s). Failed dishes will show a placeholder.`;
      } else {
        document.getElementById('resultDesc').textContent = `All ${generatedMenu.items.length} dishes have AI-generated food photos!`;
      }

      // Generate QR Code
      const qrContainer = document.getElementById('resultQrCode');
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: menuViewerUrl,
        width: 220,
        height: 220,
        colorDark: '#1a1a2e',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }

    // â”€â”€ Copy Link â”€â”€
    document.getElementById('copyLinkBtn').addEventListener('click', () => {
      navigator.clipboard.writeText(menuViewerUrl).then(() => {
        const toast = document.getElementById('copyToast');
        toast.style.display = 'inline-block';
        setTimeout(() => { toast.style.display = 'none'; }, 2500);
      }).catch(() => {
        // Fallback
        const input = document.createElement('input');
        input.value = menuViewerUrl;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        const toast = document.getElementById('copyToast');
        toast.style.display = 'inline-block';
        setTimeout(() => { toast.style.display = 'none'; }, 2500);
      });
    });

    // â”€â”€ Download QR Code â”€â”€
    document.getElementById('downloadQrBtn').addEventListener('click', () => {
      const canvas = document.querySelector('#resultQrCode canvas');
      if (canvas) {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `${(generatedMenu?.restaurant || 'menu').replace(/[^a-z0-9]/gi, '_')}_qr_code.png`;
        a.click();
      } else {
        // Fallback: try img element
        const img = document.querySelector('#resultQrCode img');
        if (img) {
          const a = document.createElement('a');
          a.href = img.src;
          a.download = `${(generatedMenu?.restaurant || 'menu').replace(/[^a-z0-9]/gi, '_')}_qr_code.png`;
          a.click();
        }
      }
    });

    // â”€â”€ Share (Web Share API) â”€â”€
    document.getElementById('shareBtn').addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: `${generatedMenu?.restaurant || 'Restaurant'} â€” Digital Menu`,
            text: `Check out our digital menu!`,
            url: menuViewerUrl
          });
        } catch (e) { /* User cancelled */ }
      } else {
        // Fallback: copy
        document.getElementById('copyLinkBtn').click();
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DOWNLOAD AS HTML
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('downloadMenuBtn').addEventListener('click', async () => {
      if (!generatedMenu) return;
      const btn = document.getElementById('downloadMenuBtn');
      btn.disabled = true;
      btn.textContent = 'Preparing download...';

      try {
        const itemsWithBase64 = [];
        for (const item of generatedMenu.items) {
          let imgData = null;
          if (item.imageUrl) {
            try {
              const resp = await fetch(item.imageUrl);
              const blob = await resp.blob();
              imgData = await blobToBase64(blob);
            } catch (e) { console.warn('Could not embed image:', e); }
          }
          itemsWithBase64.push({ ...item, imgData });
        }

        const html = buildMenuHTML(generatedMenu.restaurant, itemsWithBase64);
        const blob = new Blob([html], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${generatedMenu.restaurant.replace(/[^a-z0-9]/gi, '_')}_menu.html`;
        a.click();
      } catch (e) {
        showAlert('Download failed: ' + e.message, 'error');
      }

      btn.disabled = false;
      btn.textContent = 'â¬‡ Download as HTML';
    });

    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    function buildMenuHTML(restaurant, items) {
      const cards = items.map(item => {
        const img = item.imgData
          ? `<img src="${item.imgData}" alt="${esc(item.dish_name)}" style="width:100%;height:220px;object-fit:cover;border-radius:12px 12px 0 0;">`
          : `<div style="width:100%;height:220px;background:#e0e0e0;display:flex;align-items:center;justify-content:center;border-radius:12px 12px 0 0;color:#999;font-size:2em;">ğŸ½ï¸</div>`;
        return `<div style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.08);">
          ${img}
          <div style="padding:16px;">
            <h3 style="margin:0 0 6px;font-size:1.15em;color:#222;">${esc(item.dish_name)}</h3>
            ${item.ingredients ? `<p style="margin:0 0 8px;font-size:0.88em;color:#777;">${esc(item.ingredients)}</p>` : ''}
            ${item.price ? `<p style="margin:0;font-weight:700;color:#4caf50;font-size:1.1em;">${esc(item.price)}</p>` : ''}
          </div>
        </div>`;
      }).join('\n');

      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>${esc(restaurant)} â€” Digital Menu</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:#f8f8f8;color:#333;padding:30px 20px}
    .header{text-align:center;margin-bottom:40px}
    .header h1{font-size:2em;color:#222}
    .header p{color:#888;margin-top:6px;font-size:0.95em}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;max-width:1100px;margin:0 auto}
    .footer{text-align:center;margin-top:50px;color:#bbb;font-size:0.8em}
  </style>
</head>
<body>
  <div class="header">
    <h1>${esc(restaurant)}</h1>
    <p>Digital Menu â€” powered by MagicPlate.ai</p>
  </div>
  <div class="grid">${cards}</div>
  <div class="footer">Created with MagicPlate.ai</div>
</body>
</html>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CREATE ANOTHER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('createAnotherBtn').addEventListener('click', () => {
      // Check trial before allowing another menu
      if (!hasMenuTrialRemaining()) {
        openGate();
        return;
      }
      parsedDishes = [];
      generatedMenu = null;
      detectedSource = '';
      menuViewerUrl = '';
      fileInput.value = '';
      document.getElementById('pasteInput').value = '';
      document.getElementById('resultCard').style.display = 'none';
      document.getElementById('uploadCard').style.display = 'block';
      document.getElementById('resultQrCode').innerHTML = '';
      setStep(1);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FREE TRIAL GATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const FREE_MENU_LIMIT = 1;
    const MENU_TRIAL_KEY = 'mp_menu_creates';

    function getMenuCreateCount() {
      return parseInt(localStorage.getItem(MENU_TRIAL_KEY) || '0');
    }

    function incrementMenuCreateCount() {
      const count = getMenuCreateCount() + 1;
      localStorage.setItem(MENU_TRIAL_KEY, count.toString());
      updateMenuTrialBanner();
      return count;
    }

    function hasMenuTrialRemaining() {
      return getMenuCreateCount() < FREE_MENU_LIMIT;
    }

    function updateMenuTrialBanner() {
      const banner = document.getElementById('trialBanner');
      const text = document.getElementById('trialBannerText');
      const used = getMenuCreateCount();
      if (used >= FREE_MENU_LIMIT) {
        banner.style.background = 'linear-gradient(135deg, rgba(252,228,236,0.15), rgba(255,235,238,0.1))';
        banner.style.borderColor = 'rgba(239,154,154,0.3)';
        text.innerHTML = 'âš¡ <span>Free trial used</span> â€” Sign up to create unlimited menus!';
        text.style.color = '#ef5350';
      } else {
        const remaining = FREE_MENU_LIMIT - used;
        text.innerHTML = `ğŸ‰ <span>${remaining} Free Practice Menu${remaining > 1 ? 's' : ''}</span> â€” Try our digital menu creator, no sign-up needed!`;
      }
    }

    function openGate() {
      document.getElementById('gateFormView').style.display = 'block';
      document.getElementById('gateSuccessView').style.display = 'none';
      document.getElementById('gateOverlay').classList.add('active');
    }

    function closeGate() {
      document.getElementById('gateOverlay').classList.remove('active');
    }

    function submitGate(e) {
      e.preventDefault();
      const lead = {
        name: document.getElementById('gateName').value,
        email: document.getElementById('gateEmail').value,
        restaurant: document.getElementById('gateRestaurant').value,
        phone: document.getElementById('gatePhone').value,
        feature: 'digital-menu',
        date: new Date().toISOString()
      };
      const leads = JSON.parse(localStorage.getItem('mp_leads') || '[]');
      leads.push(lead);
      localStorage.setItem('mp_leads', JSON.stringify(leads));

      fetch('/api/leads/capture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(lead)
      }).catch(() => {});

      document.getElementById('gateFormView').style.display = 'none';
      document.getElementById('gateSuccessView').style.display = 'block';
    }

    document.getElementById('gateOverlay').addEventListener('click', function(e) {
      if (e.target === this) closeGate();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeGate();
    });

    // Initialize banner on load
    updateMenuTrialBanner();
  </script>

  <!-- Signup Gate Modal -->
  <div class="gate-overlay" id="gateOverlay">
    <div class="gate-card">
      <button class="gate-close" onclick="closeGate()">&times;</button>
      <div id="gateFormView">
        <h2>You've Used Your Free Trial!</h2>
        <p>Sign up and we'll contact you to set up a plan with <strong>unlimited</strong> digital menus.</p>
        <form class="gate-form" id="gateForm" onsubmit="submitGate(event)">
          <label for="gateName">Your Name</label>
          <input type="text" id="gateName" name="name" required placeholder="John Smith">
          <label for="gateEmail">Email Address</label>
          <input type="email" id="gateEmail" name="email" required placeholder="john@restaurant.com">
          <label for="gateRestaurant">Restaurant Name</label>
          <input type="text" id="gateRestaurant" name="restaurant" placeholder="Joe's Diner">
          <label for="gatePhone">Phone (optional)</label>
          <input type="tel" id="gatePhone" name="phone" placeholder="(555) 555-5555">
          <button type="submit" class="gate-submit">Sign Up â€” Unlock Unlimited Menus</button>
        </form>
      </div>
      <div class="gate-success" id="gateSuccessView">
        <div style="font-size:3em;margin-bottom:12px;">ğŸ‰</div>
        <h3>You're All Set!</h3>
        <p style="color:#666;">Thanks for signing up! We'll contact you within 24 hours to get your plan set up.</p>
        <a href="/features.html#pricing" style="display:inline-block;margin-top:16px;padding:12px 24px;background:linear-gradient(135deg,#4caf50,#66bb6a);color:white;border-radius:10px;text-decoration:none;font-weight:700;">View Plans</a>
      </div>
    </div>
  </div>
</body>
</html>
