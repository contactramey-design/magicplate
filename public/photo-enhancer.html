<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Photo Enhancement - MagicPlate.ai</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f5f5;
      color: #1a1a1a;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .header h1 {
      color: #4caf50;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 1.1em;
    }
    
    .upload-section {
      background: white;
      padding: 40px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .upload-zone {
      border: 3px dashed #4caf50;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: rgba(76, 175, 80, 0.05);
    }
    
    .upload-zone:hover {
      background: rgba(76, 175, 80, 0.1);
      border-color: #66bb6a;
    }
    
    .upload-zone.dragover {
      background: rgba(76, 175, 80, 0.15);
      border-color: #4caf50;
      transform: scale(1.02);
    }
    
    .upload-icon {
      font-size: 4em;
      margin-bottom: 20px;
      color: #4caf50;
    }
    
    .upload-text {
      font-size: 1.2em;
      color: #1a1a1a;
      margin-bottom: 10px;
    }
    
    .upload-hint {
      color: #666;
      font-size: 0.9em;
    }
    
    #fileInput {
      display: none;
    }
    
    .preview-section {
      background: white;
      padding: 40px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: none;
    }
    
    .preview-section.active {
      display: block;
    }
    
    /* Before/After Slider Styles */
    .before-after-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      background: #000;
    }
    
    .before-after-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 75%; /* 4:3 aspect ratio */
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      cursor: col-resize;
    }
    
    .before-image,
    .after-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      user-select: none;
      -webkit-user-select: none;
      pointer-events: none;
    }
    
    .after-image {
      clip-path: inset(0 50% 0 0);
      transition: clip-path 0.1s ease-out;
    }
    
    .slider-control {
      position: absolute;
      top: 0;
      left: 50%;
      width: 4px;
      height: 100%;
      background: #4caf50;
      cursor: col-resize;
      z-index: 10;
      transform: translateX(-50%);
      box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
    }
    
    .slider-handle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 55px;
      height: 55px;
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      border: 4px solid white;
      border-radius: 50%;
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.2s ease;
      z-index: 20;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      touch-action: none;
    }
    
    .slider-handle:active,
    .slider-handle.dragging {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.15);
      box-shadow: 0 6px 25px rgba(76, 175, 80, 0.6);
    }
    
    .after-image {
      transition: clip-path 0.05s ease-out;
    }
    
    .after-image.no-transition {
      transition: none;
    }
    
    .slider-icon {
      color: white;
      font-size: 1.5em;
      font-weight: bold;
    }
    
    .before-after-labels {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 30px;
      z-index: 5;
      pointer-events: none;
    }
    
    .label-before,
    .label-after {
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .label-after {
      background: rgba(212, 175, 55, 0.95); /* Golden yellow like homepage */
      color: white;
    }
    
    .processing {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      border: 4px solid rgba(76, 175, 80, 0.2);
      border-top: 4px solid #4caf50;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .processing-text {
      color: #4caf50;
      font-size: 1.2em;
      font-weight: 600;
    }
    
    .actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
      font-size: 1em;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    
    .btn-secondary {
      background: white;
      color: #4caf50;
      border: 2px solid #4caf50;
    }
    
    .btn-secondary:hover {
      background: #4caf50;
      color: white;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      display: none;
      text-align: center;
    }
    
    .status.success {
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
      border: 2px solid rgba(76, 175, 80, 0.3);
    }
    
    .status.error {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 2px solid rgba(245, 158, 11, 0.3);
    }
    
    .info-box {
      background: rgba(76, 175, 80, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      border-left: 4px solid #4caf50;
    }
    
    .info-box h3 {
      color: #4caf50;
      margin-bottom: 10px;
    }
    
    .info-box p {
      color: #666;
      line-height: 1.6;
    }
    
    .preview-image {
      max-width: 100%;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2em;
      }
      
      .upload-zone {
        padding: 40px 20px;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚ú® AI Photo Enhancement</h1>
      <p>Transform your menu photos with ethical AI enhancement. Make your real food photos pop without fakes.</p>
    </div>
    
    <div class="upload-section">
      <div class="upload-zone" id="uploadZone">
        <div class="upload-icon">üì∏</div>
        <div class="upload-text">Drag & drop your photo here</div>
        <div class="upload-hint">or click to browse (JPG/PNG, max 10MB)</div>
        <input type="file" id="fileInput" accept="image/jpeg,image/png" />
      </div>
      
      <div id="previewContainer" style="display: none; margin-top: 20px;">
        <img id="previewImage" class="preview-image" alt="Preview" />
        
        <!-- Fiction Level Control -->
        <div class="fictional-control" style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <label for="fictionalLevel" style="display: block; margin-bottom: 12px; font-weight: 600; color: #333; font-size: 0.95em;">
            Creative Intensity: 
            <span id="fictionalLabel" style="color: #4CAF50; font-weight: 700;">Authentic (30%)</span>
          </label>
          
          <!-- Preset Buttons -->
          <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
            <button type="button" class="preset-btn" data-level="20" style="flex: 1; min-width: 80px; padding: 8px 12px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;">Authentic</button>
            <button type="button" class="preset-btn" data-level="50" style="flex: 1; min-width: 80px; padding: 8px 12px; background: #FF9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;">Balanced</button>
            <button type="button" class="preset-btn" data-level="85" style="flex: 1; min-width: 80px; padding: 8px 12px; background: #F44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;">Magical</button>
          </div>
          
          <!-- Slider -->
          <input 
            type="range" 
            id="fictionalLevel" 
            min="0" 
            max="100" 
            value="30" 
            style="width: 100%; height: 10px; border-radius: 5px; outline: none; background: linear-gradient(to right, #4CAF50 0%, #FF9800 50%, #F44336 100%); -webkit-appearance: none; appearance: none;"
          />
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.8em; color: #666;">
            <span>0% Real</span>
            <span>50% Balanced</span>
            <span>100% Fictional</span>
          </div>
          <p id="fictionalDescription" style="margin-top: 10px; font-size: 0.85em; color: #555; text-align: center; font-style: italic;">
            Enhance food quality while keeping original background
          </p>
        </div>
        
        <div style="text-align: center;">
          <button class="btn btn-primary" id="enhanceBtn">‚ú® Enhance Photo</button>
          <button class="btn btn-secondary" id="removeBtn" style="margin-left: 10px;">Remove</button>
        </div>
      </div>
      
      <div id="status" class="status"></div>
    </div>
    
    <div class="preview-section" id="previewSection">
      <div class="processing" id="processingDiv" style="display: none;">
        <div class="spinner"></div>
        <div class="processing-text" id="processingText">Enhancing your photo...</div>
        <p style="color: #666; margin-top: 10px;">This may take 30-60 seconds</p>
      </div>

      <div id="identifiedItemsBanner" style="display:none; background:linear-gradient(135deg,#e8f5e9,#f1f8e9); border:1px solid #c8e6c9; border-radius:10px; padding:14px 18px; margin-bottom:15px;">
        <div style="font-weight:600; color:#2e7d32; margin-bottom:4px;">üîç Detected Food Items</div>
        <div id="identifiedItemsText" style="color:#333; font-size:0.95em; line-height:1.4;"></div>
      </div>
      
      <div class="before-after-container" id="sliderContainer" style="display: none;">
        <div class="before-after-wrapper" id="sliderWrapper">
          <img id="beforeImage" class="before-image" alt="Before" />
          <img id="afterImage" class="after-image" alt="After" />
          <div class="slider-control" id="sliderControl">
            <div class="slider-handle" id="sliderHandle">
              <span class="slider-icon" id="sliderIcon">‚Üî</span>
            </div>
          </div>
          <div class="before-after-labels">
            <span class="label-after">After</span>
            <span class="label-before">Before</span>
          </div>
        </div>
      </div>
      
      <div class="actions" id="actionsDiv" style="display: none;">
        <button class="btn btn-primary" id="downloadBtn">‚¨á Download Enhanced</button>
        <button class="btn btn-secondary" id="newPhotoBtn">üì∏ Enhance Another</button>
      </div>
    </div>
    
    <div class="info-box">
      <h3>‚ÑπÔ∏è Ethical Enhancement</h3>
      <p><strong>What we do:</strong> Enhance colors, lighting, textures, and sharpness to make your real food photos look professional and appetizing.</p>
      <p><strong>What we don't do:</strong> We never add, remove, or fake ingredients. Your photos stay authentic‚Äîjust better looking!</p>
    </div>
  </div>
  
  <script>
    // State management
    let currentFile = null;
    let beforeImageUrl = null;
    let afterImageUrl = null;
    
    // Fiction Level state
    let fictionalLevel = parseInt(localStorage.getItem('fictionalLevel') || '30'); // Default 30%
    let regenerationTimeout = null;
    let isRegenerating = false;
    
    // Slider state management
    let sliderInitialized = false;
    let sliderEventHandlers = {};
    let currentSliderPosition = 50;
    let isDragging = false;
    
    // DOM elements
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const enhanceBtn = document.getElementById('enhanceBtn');
    const removeBtn = document.getElementById('removeBtn');
    const fictionalLevelSlider = document.getElementById('fictionalLevel');
    const fictionalLabel = document.getElementById('fictionalLabel');
    const fictionalDescription = document.getElementById('fictionalDescription');
    const presetButtons = document.querySelectorAll('.preset-btn');
    const statusDiv = document.getElementById('status');
    const previewSection = document.getElementById('previewSection');
    const processingDiv = document.getElementById('processingDiv');
    const sliderContainer = document.getElementById('sliderContainer');
    const beforeImage = document.getElementById('beforeImage');
    const afterImage = document.getElementById('afterImage');
    const actionsDiv = document.getElementById('actionsDiv');
    const downloadBtn = document.getElementById('downloadBtn');
    const newPhotoBtn = document.getElementById('newPhotoBtn');
    const sliderControl = document.getElementById('sliderControl');
    const sliderHandle = document.getElementById('sliderHandle');
    const sliderWrapper = document.getElementById('sliderWrapper');
    
    // Upload zone click
    uploadZone.addEventListener('click', () => fileInput.click());
    
    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });
    
    // Handle file selection
    function handleFile(file) {
      // Validate file type
      if (!file.type.match(/^image\/(jpeg|png)$/)) {
        showStatus('Please upload a JPG or PNG image.', 'error');
        return;
      }
      
      // Validate file size (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showStatus('Image too large. Maximum size: 10MB', 'error');
        return;
      }
      
      currentFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
        beforeImageUrl = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    // Remove preview
    removeBtn.addEventListener('click', () => {
      currentFile = null;
      beforeImageUrl = null;
      afterImageUrl = null;
      previewContainer.style.display = 'none';
      previewSection.classList.remove('active');
      fileInput.value = '';
      clearTimeout(regenerationTimeout);
      isRegenerating = false;
    });
    
    // Fiction Level Functions
    function updateFictionalLabel(level) {
      if (!fictionalLabel || !fictionalDescription) return;
      
      if (level <= 30) {
        fictionalLabel.textContent = `Authentic (${level}%)`;
        fictionalLabel.style.color = '#4CAF50';
        fictionalDescription.textContent = 'Enhance food quality while keeping original background';
      } else if (level <= 70) {
        fictionalLabel.textContent = `Balanced (${level}%)`;
        fictionalLabel.style.color = '#FF9800';
        fictionalDescription.textContent = 'Perfect food with subtle background improvements';
      } else {
        fictionalLabel.textContent = `Magical (${level}%)`;
        fictionalLabel.style.color = '#F44336';
        fictionalDescription.textContent = 'Create new restaurant setting with perfect food';
      }
    }
    
    // Initialize fiction level slider
    if (fictionalLevelSlider) {
      fictionalLevelSlider.value = fictionalLevel;
      updateFictionalLabel(fictionalLevel);
    }
    
    // Regenerate enhancement with new fiction level
    async function regenerateEnhancement() {
      if (!currentFile || isRegenerating) return;
      
      isRegenerating = true;
      processingDiv.style.display = 'block';
      sliderContainer.style.display = 'none';
      actionsDiv.style.display = 'none';
      statusDiv.style.display = 'none';
      
      try {
        const base64 = await fileToBase64(currentFile);
        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = urlParams.get('restaurant_id') || '1';
        
        const response = await fetch('/api/enhance-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            image: base64,
            filename: currentFile.name,
            restaurant_id: parseInt(restaurantId),
            style: 'upscale_casual',
            fictional_level: fictionalLevel
          })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.message || data.error || 'Enhancement failed');
        }
        
        // Update after image
        afterImage.src = data.afterUrl || data.output[0];
        afterImageUrl = data.afterUrl || data.output[0];
        
        await waitForImages();
        processingDiv.style.display = 'none';
        sliderContainer.style.display = 'block';
        actionsDiv.style.display = 'flex';
        
      } catch (error) {
        console.error('Regeneration error:', error);
        showStatus(`Regeneration failed: ${error.message}`, 'error');
        processingDiv.style.display = 'none';
      } finally {
        isRegenerating = false;
      }
    }
    
    // Slider change handler with debounce
    if (fictionalLevelSlider) {
      fictionalLevelSlider.addEventListener('input', (e) => {
        const newLevel = parseInt(e.target.value);
        fictionalLevel = newLevel;
        localStorage.setItem('fictionalLevel', newLevel.toString());
        updateFictionalLabel(newLevel);
        
        // Debounced regeneration if image already enhanced
        if (afterImageUrl && !isRegenerating) {
          clearTimeout(regenerationTimeout);
          regenerationTimeout = setTimeout(() => {
            regenerateEnhancement();
          }, 600); // 600ms debounce
        }
      });
    }
    
    // Preset button handlers
    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const level = parseInt(btn.dataset.level);
        fictionalLevel = level;
        if (fictionalLevelSlider) {
          fictionalLevelSlider.value = level;
        }
        localStorage.setItem('fictionalLevel', level.toString());
        updateFictionalLabel(level);
        
        // Regenerate if image already enhanced
        if (afterImageUrl && !isRegenerating) {
          regenerateEnhancement();
        }
      });
    });
    
    // Enhance button
    enhanceBtn.addEventListener('click', async () => {
      if (!currentFile) return;
      
      // Hide preview, show processing
      previewContainer.style.display = 'none';
      previewSection.classList.add('active');
      processingDiv.style.display = 'block';
      document.getElementById('processingText').textContent = 'Identifying food items‚Ä¶';
      document.getElementById('identifiedItemsBanner').style.display = 'none';
      sliderContainer.style.display = 'none';
      actionsDiv.style.display = 'none';
      statusDiv.style.display = 'none';
      
      try {
        // Convert file to base64
        const base64 = await fileToBase64(currentFile);
        
        // Get restaurant ID from URL or default to 1
        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = urlParams.get('restaurant_id') || '1';
        
        // Update processing text after a few seconds to reflect stage
        const processingTextEl = document.getElementById('processingText');
        const stageTimer = setTimeout(() => {
          processingTextEl.textContent = 'Enhancing your photo with AI‚Ä¶';
        }, 8000); // After ~8s, the vision step is likely done

        // Call enhancement API
        const response = await fetch('/api/enhance-image', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            image: base64,
            filename: currentFile.name,
            restaurant_id: parseInt(restaurantId),
            style: 'upscale_casual',
            fictional_level: fictionalLevel
          })
        });

        clearTimeout(stageTimer);
        const data = await response.json();
        
        if (!response.ok) {
          // Show detailed error message
          let errorMsg = data.message || data.error || `Enhancement failed (${response.status})`;
          
          // Provide helpful messages for common errors
          if (response.status === 403) {
            errorMsg = 'Access forbidden. This usually means: (1) API key issue, (2) Insufficient credits, or (3) Rate limit exceeded. Please check your API configuration.';
          } else if (response.status === 401) {
            errorMsg = 'Authentication failed. Please check your API key configuration.';
          } else if (response.status === 402) {
            errorMsg = 'Insufficient credits. Please add credits to your AI service account.';
          }
          
          console.error('Enhancement API error:', {
            status: response.status,
            statusText: response.statusText,
            data: data
          });
          throw new Error(errorMsg);
        }
        
        // Show identified items if available
        if (data.identifiedItems) {
          const banner = document.getElementById('identifiedItemsBanner');
          document.getElementById('identifiedItemsText').textContent = data.identifiedItems;
          banner.style.display = 'block';
        }

        // Show results - set images first
        beforeImage.src = beforeImageUrl; // Original image - shown on LEFT side
        afterImage.src = data.afterUrl || data.output[0]; // Enhanced image - shown on RIGHT side
        afterImageUrl = data.afterUrl || data.output[0];
        
        await waitForImages();
        
        processingDiv.style.display = 'none';
        sliderContainer.style.display = 'block';
        actionsDiv.style.display = 'flex';
        
        await initSlider();
        
        showStatus('‚úÖ Enhancement complete! Drag the slider to compare.', 'success');
        
        // Confetti effect (simple)
        triggerConfetti();
        
      } catch (error) {
        processingDiv.style.display = 'none';
        showStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    });
    
    // Download button
    downloadBtn.addEventListener('click', () => {
      if (!afterImageUrl) return;
      
      const link = document.createElement('a');
      link.href = afterImageUrl;
      link.download = `enhanced-${currentFile.name}`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    // New photo button
    newPhotoBtn.addEventListener('click', () => {
      currentFile = null;
      beforeImageUrl = null;
      afterImageUrl = null;
      previewContainer.style.display = 'none';
      previewSection.classList.remove('active');
      fileInput.value = '';
      statusDiv.style.display = 'none';
      cleanupSlider();
    });
    
    // Wait for images to load
    function waitForImages() {
      return Promise.all([
        new Promise((resolve) => {
          if (beforeImage.complete && beforeImage.naturalWidth > 0) {
            resolve();
          } else {
            beforeImage.onload = resolve;
            beforeImage.onerror = resolve; // Continue even if image fails
          }
        }),
        new Promise((resolve) => {
          if (afterImage.complete && afterImage.naturalWidth > 0) {
            resolve();
          } else {
            afterImage.onload = resolve;
            afterImage.onerror = resolve; // Continue even if image fails
          }
        })
      ]);
    }
    
    // Cleanup slider event listeners
    function cleanupSlider() {
      if (!sliderInitialized) return;
      
      // Remove all event listeners
      Object.keys(sliderEventHandlers).forEach(key => {
        const { element, event, handler } = sliderEventHandlers[key];
        if (element && handler) {
          element.removeEventListener(event, handler);
        }
      });
      
      // Reset state
      sliderEventHandlers = {};
      sliderInitialized = false;
      isDragging = false;
      currentSliderPosition = 50;
      sliderHandle.classList.remove('dragging');
      afterImage.classList.remove('no-transition');
    }
    
    // Initialize slider
    async function initSlider() {
      // Clean up existing slider if already initialized
      if (sliderInitialized) {
        cleanupSlider();
      }
      
      // Wait for images to load before initializing
      try {
        await waitForImages();
      } catch (error) {
        console.warn('Image load warning:', error);
      }
      
      isDragging = false;
      currentSliderPosition = 50;
      
      function updateSlider(position) {
        currentSliderPosition = Math.max(0, Math.min(100, position));
        sliderControl.style.left = currentSliderPosition + '%';
        afterImage.classList.add('no-transition');
        afterImage.style.clipPath = `inset(0 ${100 - currentSliderPosition}% 0 0)`;
      }
      
      // Prevent text selection on drag
      function preventSelection(e) {
        e.preventDefault();
        return false;
      }
      
      // Mouse drag start handler
      const handleMouseDown = (e) => {
        isDragging = true;
        sliderHandle.classList.add('dragging');
        sliderHandle.style.cursor = 'grabbing';
        e.preventDefault();
        e.stopPropagation();
        // Prevent text selection
        document.addEventListener('selectstart', preventSelection);
        document.body.style.userSelect = 'none';
        document.body.style.webkitUserSelect = 'none';
      };
      
      // Mouse move handler
      const handleMouseMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        e.stopPropagation();
        const rect = sliderWrapper.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
        updateSlider(percent);
      };
      
      // Mouse up handler
      const handleMouseUp = () => {
        if (isDragging) {
          isDragging = false;
          sliderHandle.classList.remove('dragging');
          sliderHandle.style.cursor = 'grab';
          afterImage.classList.remove('no-transition');
          // Re-enable text selection
          document.removeEventListener('selectstart', preventSelection);
          document.body.style.userSelect = '';
          document.body.style.webkitUserSelect = '';
        }
      };
      
      // Touch start handler
      const handleTouchStart = (e) => {
        isDragging = true;
        sliderHandle.classList.add('dragging');
        e.preventDefault();
        e.stopPropagation();
      };
      
      // Touch move handler
      const handleTouchMove = (e) => {
        if (!isDragging) return;
        e.preventDefault();
        e.stopPropagation();
        const rect = sliderWrapper.getBoundingClientRect();
        const x = e.touches[0].clientX - rect.left;
        const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
        updateSlider(percent);
      };
      
      // Touch end handler
      const handleTouchEnd = () => {
        if (isDragging) {
          isDragging = false;
          sliderHandle.classList.remove('dragging');
          afterImage.classList.remove('no-transition');
        }
      };
      
      // Click on wrapper handler
      const handleWrapperClick = (e) => {
        // Don't trigger if clicking on handle, control, or icon
        const sliderIcon = sliderHandle.querySelector('.slider-icon');
        if (e.target === sliderHandle || e.target === sliderControl || e.target === sliderIcon || sliderHandle.contains(e.target) || sliderControl.contains(e.target)) {
          return;
        }
        const rect = sliderWrapper.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
        afterImage.classList.remove('no-transition');
        updateSlider(percent);
      };
      
      // Keyboard navigation handler
      const handleKeyDown = (e) => {
        // Only handle if slider is visible
        if (sliderContainer.style.display === 'none') return;
        
        // Don't interfere with typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        let newPosition = currentSliderPosition;
        
        switch(e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            newPosition = Math.max(0, currentSliderPosition - 5);
            afterImage.classList.remove('no-transition');
            updateSlider(newPosition);
            break;
          case 'ArrowRight':
            e.preventDefault();
            newPosition = Math.min(100, currentSliderPosition + 5);
            afterImage.classList.remove('no-transition');
            updateSlider(newPosition);
            break;
          case 'Home':
            e.preventDefault();
            afterImage.classList.remove('no-transition');
            updateSlider(0);
            break;
          case 'End':
            e.preventDefault();
            afterImage.classList.remove('no-transition');
            updateSlider(100);
            break;
        }
      };
      
      // Store handlers for cleanup
      sliderEventHandlers = {
        handleMouseDown: { element: sliderHandle, event: 'mousedown', handler: handleMouseDown },
        handleMouseMove: { element: document, event: 'mousemove', handler: handleMouseMove },
        handleMouseUp: { element: document, event: 'mouseup', handler: handleMouseUp },
        handleTouchStart: { element: sliderHandle, event: 'touchstart', handler: handleTouchStart },
        handleTouchMove: { element: document, event: 'touchmove', handler: handleTouchMove },
        handleTouchEnd: { element: document, event: 'touchend', handler: handleTouchEnd },
        handleWrapperClick: { element: sliderWrapper, event: 'click', handler: handleWrapperClick },
        handleKeyDown: { element: document, event: 'keydown', handler: handleKeyDown }
      };
      
      // Add event listeners
      sliderHandle.addEventListener('mousedown', handleMouseDown);
      sliderControl.addEventListener('mousedown', handleMouseDown);
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      sliderHandle.addEventListener('touchstart', handleTouchStart, { passive: false });
      sliderControl.addEventListener('touchstart', handleTouchStart, { passive: false });
      document.addEventListener('touchmove', handleTouchMove, { passive: false });
      document.addEventListener('touchend', handleTouchEnd);
      sliderWrapper.addEventListener('click', handleWrapperClick);
      document.addEventListener('keydown', handleKeyDown);
      
      // Initialize position
      updateSlider(50);
      afterImage.classList.remove('no-transition');
      sliderInitialized = true;
    }
    
    // Helper functions
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
    }
    
    function triggerConfetti() {
      // Simple confetti effect
      const colors = ['#4caf50', '#66bb6a', '#ffffff'];
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.style.position = 'fixed';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = '-10px';
          confetti.style.width = '10px';
          confetti.style.height = '10px';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.borderRadius = '50%';
          confetti.style.pointerEvents = 'none';
          confetti.style.zIndex = '9999';
          confetti.style.animation = `fall ${Math.random() * 2 + 1}s linear`;
          document.body.appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 3000);
        }, i * 20);
      }
      
      // Add fall animation
      if (!document.getElementById('confetti-style')) {
        const style = document.createElement('style');
        style.id = 'confetti-style';
        style.textContent = `
          @keyframes fall {
            to {
              transform: translateY(100vh) rotate(360deg);
              opacity: 0;
            }
          }
        `;
        document.head.appendChild(style);
      }
    }
  </script>
</body>
</html>
